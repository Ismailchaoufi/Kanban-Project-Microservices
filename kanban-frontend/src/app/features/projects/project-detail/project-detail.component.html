<ng-container *ngIf="!loading && project; else loadingTemplate">
  <div class="project-detail">

    <!-- ===== PROJECT HEADER ===== -->
    <header class="project-header">
      <div class="header-content">
        <h1>{{ project.title }}</h1>
        <p class="project-description">{{ project.description }}</p>
      </div>

      <div class="header-actions">
        <mat-chip
          [ngClass]="['status-chip', getStatusClass(project.status)]"
          [attr.aria-label]="'Project status: ' + project.status">
          {{ project.status | titlecase }}
        </mat-chip>

        <button
          mat-raised-button
          color="primary"
          (click)="toggleMembersPanel()"
          class="members-btn"
          [attr.aria-label]="'View ' + members.length + ' project members'">
          <mat-icon>group</mat-icon>
          <span>Members ({{ members.length }})</span>
        </button>
      </div>
    </header>

    <!-- ===== MEMBERS PANEL ===== -->
    <aside
      class="members-panel"
      [class.show]="showMembersPanel"
      role="complementary"
      [attr.aria-hidden]="!showMembersPanel">

      <!-- Panel Header -->
      <div class="panel-header">
        <h2>
          <mat-icon aria-hidden="true">group</mat-icon>
          <span>Project Members</span>
        </h2>
        <button
          mat-icon-button
          (click)="toggleMembersPanel()"
          matTooltip="Close panel"
          aria-label="Close members panel">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Panel Content -->
      <div class="panel-content">

        <!-- Add Member Button -->
        <button
          *ngIf="canManageMembers()"
          mat-raised-button
          color="primary"
          (click)="openAddMemberModal()"
          class="add-member-btn"
          aria-label="Add new member to project">
          <mat-icon>person_add</mat-icon>
          <span>Add Member</span>
        </button>

        <!-- Loading State -->
        <div *ngIf="loadingMembers" class="loading-state">
          <mat-spinner diameter="40" aria-label="Loading members"></mat-spinner>
          <p>Loading members...</p>
        </div>

        <!-- Members List -->
        <div *ngIf="!loadingMembers && members.length > 0" class="members-list">
          <div
            *ngFor="let member of members; trackBy: trackByUserId"
            class="member-card">

            <div class="member-info">
              <div
                class="member-avatar"
                [style.background-color]="getAvatarColor(member.userId)"
                [attr.aria-label]="'Avatar for ' + getMemberFullName(member)">
                {{ getMemberInitials(member) }}
              </div>

              <div class="member-details">
                <h3>{{ getMemberFullName(member) }}</h3>
                <p class="member-email">{{ member.email }}</p>
              </div>
            </div>

            <div class="member-actions">
              <!-- Remove Button -->
              <button
                *ngIf="canRemoveMember(member)"
                mat-icon-button
                color="warn"
                (click)="removeMember(member.userId, getMemberFullName(member))"
                matTooltip="Remove member"
                [attr.aria-label]="'Remove ' + getMemberFullName(member) + ' from project'">
                <mat-icon>person_remove</mat-icon>
              </button>

              <!-- Owner Badge -->
              <mat-chip
                *ngIf="member.userId === project.ownerId"
                class="owner-badge"
                aria-label="Project owner">
                Owner
              </mat-chip>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loadingMembers && members.length === 0" class="empty-state">
          <mat-icon aria-hidden="true">group_off</mat-icon>
          <p>No members in this project yet</p>
          <p class="empty-state-hint" *ngIf="canManageMembers()">
            Click "Add Member" to invite team members
          </p>
        </div>
      </div>
    </aside>

    <!-- ===== OVERLAY ===== -->
    <div
      class="overlay"
      *ngIf="showMembersPanel || showAddMemberModal"
      (click)="showMembersPanel ? toggleMembersPanel() : closeAddMemberModal()"
      role="presentation"
      aria-hidden="true">
    </div>

    <!-- ===== ADD MEMBER MODAL ===== -->
    <div
      class="add-member-modal"
      [class.show]="showAddMemberModal"
      role="dialog"
      aria-labelledby="modal-title"
      [attr.aria-hidden]="!showAddMemberModal">

      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h2 id="modal-title">
            <mat-icon>mail</mat-icon>
            <span>Invite Member</span>
          </h2>
          <button
            mat-icon-button
            (click)="closeAddMemberModal()"
            aria-label="Close modal">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email address</mat-label>
            <input
              matInput
              type="email"
              [(ngModel)]="inviteEmail"
              placeholder="example@email.com"
              (keyup.enter)="inviteMember()"
              required
              autofocus />
            <mat-icon matPrefix>email</mat-icon>
          </mat-form-field>

          <div class="hint">
            <mat-icon>info</mat-icon>
            <p>
              The user will be added automatically if they already exist,
              otherwise an invitation email will be sent.
            </p>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
          <button
            mat-button
            (click)="closeAddMemberModal()"
            [disabled]="inviting">
            Cancel
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="inviteMember()"
            [disabled]="!inviteEmail || inviting">
            <mat-spinner *ngIf="inviting" diameter="16"></mat-spinner>
            <span *ngIf="!inviting">Send Invite</span>
            <span *ngIf="inviting">Sending...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== KANBAN BOARD ===== -->
    <section class="kanban-section" aria-label="Project tasks board">
      <app-kanban-board [projectId]="projectId"></app-kanban-board>
    </section>

  </div>
</ng-container>

<!-- ===== LOADING TEMPLATE ===== -->
<ng-template #loadingTemplate>
  <div class="loading-state main-loading">
    <mat-spinner diameter="50" aria-label="Loading project"></mat-spinner>
    <p>Loading project details...</p>
  </div>
</ng-template>
