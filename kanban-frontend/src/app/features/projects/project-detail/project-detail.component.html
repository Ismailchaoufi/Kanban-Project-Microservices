<ng-container *ngIf="!loading && project; else loadingTemplate">
  <div class="project-detail">
    <!-- Project Header -->
    <header class="project-header">
      <div class="header-content">
        <h1>{{ project.title }}</h1>
        <p class="project-description">{{ project.description }}</p>
      </div>
      <div class="header-actions">
        <mat-chip
          [class]="'status-chip status-' + project.status.toLowerCase()"
          [attr.aria-label]="'Project status: ' + project.status">
          {{ project.status | titlecase }}
        </mat-chip>
        <button
          mat-raised-button
          color="primary"
          (click)="toggleMembersPanel()"
          class="members-btn"
          [attr.aria-label]="'View ' + members.length + ' project members'">
          <mat-icon>group</mat-icon>
          <span>Members ({{ members.length }})</span>
        </button>
      </div>
    </header>

    <!-- Members Panel (Slide-in) -->
    <aside
      class="members-panel"
      [class.show]="showMembersPanel"
      role="complementary"
      [attr.aria-hidden]="!showMembersPanel">
      <div class="panel-header">
        <h2>
          <mat-icon aria-hidden="true">group</mat-icon>
          <span>Project Members</span>
        </h2>
        <button
          mat-icon-button
          (click)="toggleMembersPanel()"
          matTooltip="Close panel"
          aria-label="Close members panel">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="panel-content">
        <!-- Add Member Button (Only for Owner and Admin) -->
        <button
          *ngIf="isOwner() || isAdmin()"
          mat-raised-button
          color="primary"
          (click)="openAddMemberModal()"
          class="add-member-btn"
          aria-label="Add new member to project">
          <mat-icon>person_add</mat-icon>
          <span>Add Member</span>
        </button>

        <!-- Loading Members -->
        <div *ngIf="loadingMembers" class="loading-state">
          <mat-spinner diameter="40" aria-label="Loading members"></mat-spinner>
          <p>Loading members...</p>
        </div>

        <!-- Members List -->
        <div *ngIf="!loadingMembers && members.length > 0" class="members-list">
          <mat-card
            *ngFor="let member of members; trackBy: trackByUserId"
            class="member-card">
            <div class="member-info">
              <div
                class="member-avatar"
                [style.background-color]="getAvatarColor(member.userId)"
                [attr.aria-label]="'Avatar for ' + member.firstName + ' ' + member.lastName">
                {{ getMemberInitials(member) }}
              </div>
              <div class="member-details">
                <h3>{{ member.firstName }} {{ member.lastName }}</h3>
                <p class="member-email">{{ member.email }}</p>
              </div>
            </div>
            <div class="member-actions">
              <button
                *ngIf="isOwner() && member.userId !== project.ownerId"
                mat-icon-button
                color="warn"
                (click)="removeMember(member.userId, member.firstName + ' ' + member.lastName)"
                matTooltip="Remove member"
                [attr.aria-label]="'Remove ' + member.firstName + ' ' + member.lastName + ' from project'">
                <mat-icon>person_remove</mat-icon>
              </button>
              <mat-chip
                *ngIf="member.userId === project.ownerId"
                class="owner-badge"
                aria-label="Project owner">
                Owner
              </mat-chip>
            </div>
          </mat-card>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loadingMembers && members.length === 0" class="empty-state">
          <mat-icon aria-hidden="true">group_off</mat-icon>
          <p>No members in this project yet</p>
          <p class="empty-state-hint" *ngIf="isOwner()">Click "Add Member" to invite team members</p>
        </div>
      </div>
    </aside>

    <!-- Overlay -->
    <div
      class="overlay"
      *ngIf="showMembersPanel || showAddMemberModal"
      (click)="showMembersPanel ? toggleMembersPanel() : closeAddMemberModal()"
      role="presentation"
      aria-hidden="true">
    </div>

    <!-- Add Member Modal -->
    <div
      class="add-member-modal"
      [class.show]="showAddMemberModal"
      role="dialog"
      aria-labelledby="modal-title"
      [attr.aria-hidden]="!showAddMemberModal">

      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">
            <mat-icon>mail</mat-icon>
            <span>Invite Member</span>
          </h2>
          <button mat-icon-button (click)="closeAddMemberModal()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="modal-body">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email address</mat-label>
            <input
              matInput
              type="email"
              [(ngModel)]="inviteEmail"
              placeholder="example@email.com"
              required />
          </mat-form-field>

          <p class="hint">
            The user will be added automatically if they already exist,
            otherwise an invitation email will be sent.
          </p>
        </div>

        <div class="modal-footer">
          <button mat-button (click)="closeAddMemberModal()">Cancel</button>
          <button
            mat-raised-button
            color="primary"
            (click)="inviteMember()"
            [disabled]="!inviteEmail || inviting">
            Invite
          </button>
        </div>
      </div>
    </div>


    <!-- Kanban Board -->
    <section class="kanban-section" aria-label="Project tasks board">
      <app-kanban-board [projectId]="projectId"></app-kanban-board>
    </section>
  </div>
</ng-container>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="loading-state main-loading">
    <mat-spinner diameter="50" aria-label="Loading project"></mat-spinner>
    <p>Loading project details...</p>
  </div>
</ng-template>
